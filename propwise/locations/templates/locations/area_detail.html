{% extends 'base.html' %}
{% load static %}
{% comment %} We do NOT need '{% load chartjs %}' - we removed that broken library {% endcomment %}

{% block content %}

{% comment %}
    ============================================================
    STEP 1: ALL CSS LIBRARIES
    ============================================================
{% endcomment %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />

{% comment %}
    ============================================================
    STEP 2: ALL JAVASCRIPT LIBRARIES
    ============================================================
{% endcomment %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


{% comment %}
    STEP 3: Our custom styles for the page
{% endcomment %}
<style>
    #area-map { height: 450px; width: 100%; border-radius: 8px; border: 1px solid #ddd; }
    .amenities-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 768px) { .amenities-grid { grid-template-columns: 1fr 1fr; } }
    .amenity-group { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px 20px; }
    .amenity-group h4 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 8px; font-size: 1.2em; }
    .amenity-group ul { list-style-type: none; padding-left: 0; margin: 0; }
    .amenity-group li { padding: 6px 0; border-bottom: 1px dashed #ddd; }
    .amenity-group li:last-child { border-bottom: none; }
    .property-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .property-card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
    .property-card img { max-width: 100%; height: 200px; object-fit: cover; border-radius: 4px; }
    .price-chart-container {
        margin-top: 30px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 20px;
    }
</style>

{% comment %}
    ============================================================
    STEP 4: THE HTML BODY OF THE PAGE
    ============================================================
{% endcomment %}
<div class="container" style="margin-top: 20px;">
    
    <h2>Properties in {{ area.name }}, {{ area.city.name }}</h2>
    <p>
        <a href="{% url 'city_detail' city_pk=area.city.pk %}">
            ‚Üê Back to all areas in {{ area.city.name }}
        </a>
    </p>

    <hr style="margin: 20px 0;">
    
    <div class="insights-container" style="margin-bottom: 30px;">

        {% if area.description %}
            <div class="neighborhood-about" style="margin-bottom: 25px;">
                <h3>About {{ area.name }}</h3>
                <p style="font-size: 16px; line-height: 1.6;">
                    {{ area.description|linebreaksbr }}
                </p>
            </div>
        {% endif %}

        {% if area.latitude and area.longitude %}
            <div class="neighborhood-map" style="margin-bottom: 30px;">
                <h3>Location Map</h3>
                <div id="area-map"
                     data-lat="{{ area.latitude }}"
                     data-lng="{{ area.longitude }}"
                     data-area-name="{{ area.name|escapejs }}"
                     data-amenities-json='{{ amenities_json|safe }}'>
                </div>
            </div>
        {% endif %}

        {% if amenities_by_type %}
            <div class="neighborhood-nearby" style="margin-top: 30px;">
                <h3>What's Nearby in {{ area.name }}</h3>
                <div class="amenities-grid">
                    {% for type_name, amenity_list in amenities_by_type.items %}
                        <div class="amenity-group">
                            <h4>{{ type_name }} ({{ amenity_list|length }})</h4>
                            <ul>
                                {% for amenity in amenity_list %}
                                    <li>{{ amenity.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        {% comment %}
        {% endcomment %}
        
        {% comment %}
            We check the PYTHON list 'price_chart_labels'.
            It will only have data if the view found 2 or more months.
        {% endcomment %}
        {% if price_chart_labels %} 
            <div class="price-chart-container">
                <h3>Average Sold Price Trends in {{ area.name }}</h3>
                <p style="font-size: 0.9em; color: #666;">
                    Based on properties sold in the last 12 months.
                </p>
                
                {% comment %}
                  THIS IS THE FIXED CANVAS.
                  It passes the data to our 'price_chart.js' file.
                  We use |safe to handle the JSON strings from the view.
                  Note: The view code I gave you last time was correct.
                  It passes *JSON strings*, not Python lists.
                {% endcomment %}
                <canvas id="priceTrendChart"
                        data-labels='{{ price_chart_labels|safe }}'
                        data-data='{{ price_chart_data|safe }}'>
                </canvas>
            </div>
        {% endif %}
        
        {% comment %}
        {% endcomment %}

    </div> <hr style="margin: 20px 0;">

    <h3>Active Properties in {{ area.name }}</h3>

    <div class="property-list">
        {% for prop in properties %}
            <div class="property-card">
                
                {% if prop.main_image %}
                    <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                {% endif %}
                
                <h4><a href="{% url 'property_detail' pk=prop.pk %}">{{ prop.title }}</a></h4>
                <p><strong>Price:</strong> PKR {{ prop.price }}</p>
                <p><strong>Location:</strong> {{ prop.area }}</p>
                <p><strong>Type:</strong> {{ prop.get_property_type_display }}</p>
                
                <p style="margin-top: 10px;">
                    <a href="{% url 'property_detail' pk=prop.pk %}" style="display: inline-block; padding: 8px 16px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
                        View Details
                    </a>
                    
                    {% comment %} This is your full Save/Unsave button logic {% endcomment %}
                    {% if user.is_authenticated %}
                        {% if prop in user.favorites.all %}
                            <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #dc3545; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Unsave</button>
                            </form>
                        {% else %}
                            <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #007bff; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Save</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}?next={{ request.path }}" style="
                            background: #007bff; color: white; padding: 5px 10px; border: none; 
                            border-radius: 4px; font-size: 14px; margin-left: 10px; text-decoration: none;
                        ">Save</a>
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>There are no active properties listed in this area right now. Sold properties are not shown here.</p>
        {% endfor %}
    </div>

</div>

{% comment %}
    ============================================================
    STEP 5: ALL JAVASCRIPT LOGIC (LOADED AT THE END)
    ============================================================
{% endcomment %}

<script src="{% static 'js/area_map.js' %}"></script>

<script src="{% static 'js/price_chart.js' %}"></script>

{% endblock content %}