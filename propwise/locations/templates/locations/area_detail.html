{% extends 'base.html' %}

{% block content %}
<div class="container" style="margin-top: 20px;">
    
    <h2>Properties in {{ area.name }}, {{ area.city.name }}</h2>
    <p>
        <a href="{% url 'city_detail' city_pk=area.city.pk %}">
            &larr; Back to all areas in {{ area.city.name }}
        </a>
    </p>

    <hr style="margin: 20px 0;">

    <div class="property-list">
        {% for prop in properties %}
            <div class="property-card">
                
                {% if prop.main_image %}
                    <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                {% endif %}
                
                <h4>
                    <a href="{% url 'property_detail' pk=prop.pk %}">
                        {{ prop.title }}
                    </a>
                </h4>

                <p><strong>Price:</strong> PKR {{ prop.price }}</p>
                <p><strong>Location:</strong> {{ prop.area }}</p>
                <p><strong>Type:</strong> {{ prop.get_property_type_display }}</p>
                
                <p style="margin-top: 10px;">
                    <a href="{% url 'property_detail' pk=prop.pk %}" style="
                        display: inline-block;
                        padding: 8px 16px;
                        background-color: #0066cc;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 14px;
                    ">
                        View Details
                    </a>
                    <!-- this id of add to favourite and remove -->
                     {% comment %} This is the new "Save/Unsave" button logic {% endcomment %}

{% if user.is_authenticated %}
    {% comment %} Check if this property is in the user's favorites list {% endcomment %}
    
    {% if prop in user.favorites.all %}
        {% comment %} If YES, show the "Unsave" button {% endcomment %}
        <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
            {% csrf_token %}
            <button type-"submit" style="
                background: #dc3545; /* Red */
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-left: 10px;
            ">
                Unsave
            </button>
        </form>
        
    {% else %}
        {% comment %} If NO, show the "Save" button {% endcomment %}
        <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
            {% csrf_token %}
            <button type="submit" style="
                background: #007bff; /* Blue */
                color: white;
                padding: 5px 10px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
                margin-left: 10px;
            ">
                Save
            </button>
        </form>
    {% endif %}

{% else %}
    {% comment %} If user is NOT logged in, link to login page {% endcomment %}
    <a href="{% url 'login' %}?next={{ request.path }}" style="
        background: #007bff; /* Blue */
        color: white;
        padding: 5px 10px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        margin-left: 10px;
        text-decoration: none;
    ">
        Save
    </a>
{% endif %}
                </p>

            </div>
        {% empty %}
            <p>No properties have been listed in this area yet. Please check back soon!</p>
        {% endfor %}
    </div>

</div>
{% endblock content %}