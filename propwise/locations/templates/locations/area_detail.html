{% extends 'base.html' %}
{% load static %}
{% load humanize %} <!-- 1. ADD THIS to use the 'timesince' filter -->

{% block content %}

{% comment %}
    ============================================================
    STEP 1: ALL CSS LIBRARIES
    ============================================================
{% endcomment %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />

{% comment %}
    ============================================================
    STEP 2: ALL JAVASCRIPT LIBRARIES
    ============================================================
{% endcomment %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


{% comment %}
    STEP 3: Our custom styles for the page
{% endcomment %}
<style>
    #area-map { height: 450px; width: 100%; border-radius: 8px; border: 1px solid #ddd; }
    .amenities-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 768px) { .amenities-grid { grid-template-columns: 1fr 1fr; } }
    .amenity-group { background: #f9f9f9; border: 1px solid #eee; border-radius: 8px; padding: 15px 20px; }
    .amenity-group h4 { margin-top: 0; border-bottom: 2px solid #007bff; padding-bottom: 8px; font-size: 1.2em; }
    .amenity-group ul { list-style-type: none; padding-left: 0; margin: 0; }
    .amenity-group li { padding: 6px 0; border-bottom: 1px dashed #ddd; }
    .amenity-group li:last-child { border-bottom: none; }
    .property-list { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
    .property-card { border: 1px solid #ccc; padding: 15px; border-radius: 8px; }
    .property-card img { max-width: 100%; height: 200px; object-fit: cover; border-radius: 4px; }
    .price-chart-container {
        margin-top: 30px;
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 20px;
    }
    
    /* --- 2. START: NEW STYLES FOR Q&A SECTION --- */
    .qa-container {
        margin-top: 30px;
        background: #fff;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 20px;
    }
    .ask-question-form {
        background: #f9f9f9;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }
    .ask-question-form h3 { margin-top: 0; }
    .ask-question-form input[type="text"],
    .ask-question-form textarea {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    .ask-question-form button {
        background: #007bff;
        color: white;
        padding: 12px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1em;
    }
    
    .question-card {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }
    .question-card:last-child { border-bottom: none; }
    
    .question-header {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
    }
    .question-meta {
        font-size: 0.9em;
        color: #666;
        margin: 5px 0 10px 0;
    }
    .question-body {
        line-height: 1.6;
    }
    
    .answer-list {
        padding-left: 20px;
        border-left: 3px solid #007bff;
        margin-top: 15px;
    }
    .answer-card {
        padding: 10px 0;
        border-bottom: 1px dashed #ddd;
    }
    .answer-card:last-child { border-bottom: none; }
    .answer-meta {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 5px;
    }
    .answer-meta strong { color: #0056b3; }
    
    .answer-form textarea {
        width: 100%;
        padding: 8px;
        margin-top: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box;
    }
    .answer-form button {
        background: #28a745;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.9em;
        margin-top: 5px;
    }
    /* --- END: NEW STYLES FOR Q&A SECTION --- */

</style>

{% comment %}
    ============================================================
    STEP 4: THE HTML BODY OF THE PAGE
    ============================================================
{% endcomment %}
<div class="container" style="margin-top: 20px;">
    
    <h2>Properties in {{ area.name }}, {{ area.city.name }}</h2>
    <p>
        <a href="{% url 'city_detail' city_pk=area.city.pk %}">
            ‚Üê Back to all areas in {{ area.city.name }}
        </a>
    </p>

    <hr style="margin: 20px 0;">
    
    <div class="insights-container" style="margin-bottom: 30px;">

        {% if area.description %}
            <div class="neighborhood-about" style="margin-bottom: 25px;">
                <h3>About {{ area.name }}</h3>
                <p style="font-size: 16px; line-height: 1.6;">
                    {{ area.description|linebreaksbr }}
                </p>
            </div>
        {% endif %}

        {% if area.latitude and area.longitude %}
            <div class="neighborhood-map" style="margin-bottom: 30px;">
                <h3>Location Map</h3>
                <div id="area-map"
                     data-lat="{{ area.latitude }}"
                     data-lng="{{ area.longitude }}"
                     data-area-name="{{ area.name|escapejs }}"
                     data-amenities-json='{{ amenities_json|safe }}'>
                </div>
            </div>
        {% endif %}

        {% if amenities_by_type %}
            <div class="neighborhood-nearby" style="margin-top: 30px;">
                <h3>What's Nearby in {{ area.name }}</h3>
                <div class="amenities-grid">
                    {% for type_name, amenity_list in amenities_by_type.items %}
                        <div class="amenity-group">
                            <h4>{{ type_name }} ({{ amenity_list|length }})</h4>
                            <ul>
                                {% for amenity in amenity_list %}
                                    <li>{{ amenity.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
        
        {% if price_chart_labels %} 
            <div class="price-chart-container">
                <h3>Average Sold Price Trends in {{ area.name }}</h3>
                <p style="font-size: 0.9em; color: #666;">
                    Based on properties sold in the last 12 months.
                </p>
                <canvas id="priceTrendChart"
                        data-labels='{{ price_chart_labels|safe }}'
                        data-data='{{ price_chart_data|safe }}'>
                </canvas>
            </div>
        {% endif %}
        
    </div> <!-- This closes the .insights-container -->

    {% comment %}
    <!-- ================================================== -->
    <!-- === START: NEW "COMMUNITY Q&A" MODULE === -->
    <!-- ================================================== -->
    {% endcomment %}
    <div class="qa-container">
        <h2>Community Q&A for {{ area.name }}</h2>
        
        <!-- 1. "Ask a Question" Form -->
        <div class="ask-question-form">
            <h3>Ask a Question</h3>
            {% if user.is_authenticated %}
                <form action="{% url 'add_question' area_pk=area.pk %}" method="POST">
                    {% csrf_token %}
                    {{ question_form.as_p }}
                    <button type="submit">Post Your Question</button>
                </form>
            {% else %}
                <p><a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to ask a question.</p>
            {% endif %}
        </div>
        
        <!-- 2. "Recent Questions" List -->
        <h3>Recent Questions</h3>
        <div class="question-list">
            {% for question in questions %}
                <div class="question-card">
                    <p class="question-header">{{ question.title }}</p>
                    <p class="question-meta">
                        Asked by <strong>{{ question.user.username|default:"Anonymous" }}</strong>
                        {{ question.created_at|timesince }} ago
                    </p>
                    {% if question.body %}
                        <p class="question-body">{{ question.body|linebreaksbr }}</p>
                    {% endif %}
                    
                    <!-- 3. List of Answers for this Question -->
                    <div class="answer-list">
                        {% for answer in question.answers.all %}
                            <div class="answer-card">
                                <p class="answer-meta">
                                    <strong>{{ answer.user.username|default:"Anonymous" }}</strong>
                                    {% if answer.user.is_agent %}(Agent){% endif %}
                                    answered {{ answer.created_at|timesince }} ago:
                                </p>
                                <p>{{ answer.body|linebreaksbr }}</p>
                            </div>
                        {% empty %}
                            <p style="font-size: 0.9em; color: #666;">No answers yet. Be the first to help!</p>
                        {% endfor %}
                        
                        <!-- 4. "Add an Answer" Form -->
                        <div class="answer-form">
                            {% if user.is_authenticated %}
                                <form action="{% url 'add_answer' question_pk=question.pk %}" method="POST">
                                    {% csrf_token %}
                                    {{ answer_form.as_p }}
                                    <button type="submit">Post Answer</button>
                                </form>
                            {% else %}
                                <p style="font-size: 0.9em; margin-top: 10px;">
                                    <a href="{% url 'login' %}?next={{ request.path }}">Log in</a> to post an answer.
                                </p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <p>No questions have been asked about this area yet. Be the first!</p>
            {% endfor %}
        </div>
    </div>
    {% comment %}
    <!-- ================================================== -->
    <!-- === END: "COMMUNITY Q&A" MODULE === -->
    <!-- ================================================== -->
    {% endcomment %}

    <hr style="margin: 40px 0;">

    <h3>Active Properties in {{ area.name }}</h3>

    <div class="property-list">
        {% for prop in properties %}
            <div class="property-card">
                
                {% if prop.main_image %}
                    <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                {% endif %}
                
                <h4><a href="{% url 'property_detail' pk=prop.pk %}">{{ prop.title }}</a></h4>
                <p><strong>Price:</strong> PKR {{ prop.price|intcomma }}</p>
                <p><strong>Location:</strong> {{ prop.area }}</p>
                <p><strong>Type:</strong> {{ prop.get_property_type_display }}</p>
                
                <p style="margin-top: 10px;">
                    <a href="{% url 'property_detail' pk=prop.pk %}" style="display: inline-block; padding: 8px 16px; background-color: #0066cc; color: white; text-decoration: none; border-radius: 4px; font-size: 14px;">
                        View Details
                    </a>
                    
                    {% if user.is_authenticated %}
                        {% if prop in user.favorites.all %}
                            <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #dc3545; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Unsave</button>
                            </form>
                        {% else %}
                            <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #007bff; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Save</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}?next={{ request.path }}" style="
                            background: #007bff; color: white; padding: 5px 10px; border: none; 
                            border-radius: 4px; font-size: 14px; margin-left: 10px; text-decoration: none;
                        ">Save</a>
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>There are no active properties listed in this area right now. Sold properties are not shown here.</p>
        {% endfor %}
    </div>

</div>

{% comment %}
    ============================================================
    STEP 5: ALL JAVASCRIPT LOGIC (LOADED AT THE END)
    ============================================================
{% endcomment %}
<script src="{% static 'js/area_map.js' %}"></script>
<script src="{% static 'js/price_chart.js' %}"></script>

{% endblock content %}