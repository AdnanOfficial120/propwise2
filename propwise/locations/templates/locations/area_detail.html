{% extends 'base.html' %}
{% load static %}

{% block content %}

{% comment %}
    ============================================================
    STEP 1: ALL CSS LIBRARIES (IN THE CORRECT ORDER)
    ============================================================
{% endcomment %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />

<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" />

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css" />

{% comment %}
    ============================================================
    STEP 2: ALL JAVASCRIPT LIBRARIES (IN THE CORRECT ORDER)
    ============================================================
{% endcomment %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.min.js"></script>


{% comment %}
    STEP 3: Our custom styles for the page
{% endcomment %}
<style>
    /* This style is for the new Leaflet map */
    #area-map {
        height: 450px;
        width: 100%;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .amenities-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 20px;
    }
    @media (min-width: 768px) {
        .amenities-grid {
            grid-template-columns: 1fr 1fr;
        }
    }
    .amenity-group {
        background: #f9f9f9;
        border: 1px solid #eee;
        border-radius: 8px;
        padding: 15px 20px;
    }
    .amenity-group h4 {
        margin-top: 0;
        border-bottom: 2px solid #007bff;
        padding-bottom: 8px;
        font-size: 1.2em;
    }
    .amenity-group ul {
        list-style-type: none;
        padding-left: 0;
        margin: 0;
    }
    .amenity-group li {
        padding: 6px 0;
        border-bottom: 1px dashed #ddd;
    }
    .amenity-group li:last-child {
        border-bottom: none;
    }
    .property-list { 
        display: grid; 
        grid-template-columns: repeat(3, 1fr);
        gap: 20px; 
    }
    .property-card { 
        border: 1px solid #ccc; 
        padding: 15px; 
        border-radius: 8px; 
    }
    .property-card img { 
        max-width: 100%; 
        height: 200px;
        object-fit: cover;
        border-radius: 4px; 
    }
</style>

{% comment %}
    ============================================================
    STEP 4: THE HTML BODY OF THE PAGE
    ============================================================
{% endcomment %}
<div class="container" style="margin-top: 20px;">
    
    <h2>Properties in {{ area.name }}, {{ area.city.name }}</h2>
    <p>
        <a href="{% url 'city_detail' city_pk=area.city.pk %}">
            ‚Üê Back to all areas in {{ area.city.name }}
        </a>
    </p>

    <hr style="margin: 20px 0;">
    
    <div class="insights-container" style="margin-bottom: 30px;">

        {% if area.description %}
            <div class="neighborhood-about" style="margin-bottom: 25px;">
                <h3>About {{ area.name }}</h3>
                <p style="font-size: 16px; line-height: 1.6;">
                    {{ area.description|linebreaksbr }}
                </p>
            </div>
        {% endif %}

        {% if area.latitude and area.longitude %}
            <div class="neighborhood-map" style="margin-bottom: 30px;">
                <h3>Location Map</h3>
                
                <div id="area-map"
                     data-lat="{{ area.latitude }}"
                     data-lng="{{ area.longitude }}"
                     data-area-name="{{ area.name|escapejs }}"
                     data-amenities-json='{{ amenities_json|safe }}'>
                </div>
            </div>
        {% endif %}

        {% if amenities_by_type %}
            <div class="neighborhood-nearby" style="margin-top: 30px;">
                <h3>What's Nearby in {{ area.name }}</h3>
                <div class="amenities-grid">
                    {% for type_name, amenity_list in amenities_by_type.items %}
                        <div class="amenity-group">
                            <h4>{{ type_name }} ({{ amenity_list|length }})</h4>
                            <ul>
                                {% for amenity in amenity_list %}
                                    <li>{{ amenity.name }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

    </div> <hr style="margin: 20px 0;">

    <h3>Properties in {{ area.name }}</h3>

    <div class="property-list">
        {% for prop in properties %}
            <div class="property-card">
                
                {% if prop.main_image %}
                    <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                {% endif %}
                
                <h4>
                    <a href="{% url 'property_detail' pk=prop.pk %}">
                        {{ prop.title }}
                    </a>
                </h4>

                <p><strong>Price:</strong> PKR {{ prop.price }}</p>
                <p><strong>Location:</strong> {{ prop.area }}</p>
                <p><strong>Type:</strong> {{ prop.get_property_type_display }}</p>
                
                <p style="margin-top: 10px;">
                    <a href="{% url 'property_detail' pk=prop.pk %}" style="
                        display: inline-block; padding: 8px 16px; background-color: #0066cc;
                        color: white; text-decoration: none; border-radius: 4px; font-size: 14px;
                    ">
                        View Details
                    </a>
                    
                    {% if user.is_authenticated %}
                        {% if prop in user.favorites.all %}
                            <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #dc3545; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Unsave</button>
                            </form>
                        {% else %}
                            <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #007bff; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Save</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}?next={{ request.path }}" style="
                            background: #007bff; color: white; padding: 5px 10px; border: none; 
                            border-radius: 4px; font-size: 14px; margin-left: 10px; text-decoration: none;
                        ">Save</a>
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>No properties have been listed in this area yet. Please check back soon!</p>
        {% endfor %}
    </div>

</div>

{% comment %}
    ============================================================
    STEP 5: OUR OWN JAVASCRIPT FILE, LOADED AT THE VERY END
    ============================================================
{% endcomment %}
<script src="{% static 'js/area_map.js' %}"></script>

{% endblock content %}