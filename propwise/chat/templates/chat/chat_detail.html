{% extends 'base.html' %}

{% block content %}
<div class="container" style="margin-top: 20px;">
    <div style="max-width: 800px; margin: auto;">
        
        <h2 style="margin-bottom: 5px;">
            Chat about: {{ thread.property.title|default:"Deleted Property" }}
        </h2>
        <p style="margin-bottom: 20px;">
            With: 
            {% if thread.buyer == user %}
                <strong>{{ thread.agent.username }}</strong> (Agent)
            {% else %}
                <strong>{{ thread.buyer.username }}</strong> (Buyer)
            {% endif %}
        </p>

        {% comment %} This is the chat message display area {% endcomment %}
        <div class="chat-messages" style="height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; border-radius: 8px; margin-bottom: 20px;">
            
            {% for message in thread.messages.all %}
                {% if message.sender == user %}
                    <div class="my-message" style="text-align: right; margin-bottom: 10px;">
                        <div style="background: #0066cc; color: white; display: inline-block; padding: 10px; border-radius: 8px; max-width: 70%;">
                            <strong>You</strong><br>
                            {{ message.body }}
                            <br>
                            <small style="color: #ddd;">{{ message.timestamp|timesince }} ago</small>
                        </div>
                    </div>
                {% else %}
                    <div class="other-message" style="text-align: left; margin-bottom: 10px;">
                        <div style="background: #e9e9e9; color: black; display: inline-block; padding: 10px; border-radius: 8px; max-width: 70%;">
                            <strong>{{ message.sender.username|default:"Deleted User" }}</strong><br>
                            {{ message.body }}
                            <br>
                            <small style="color: #555;">{{ message.timestamp|timesince }} ago</small>
                        </div>
                    </div>
                {% endif %}
            {% empty %}
                <p style="text-align: center; color: #777;">This is the beginning of your conversation.</p>
            {% endfor %}
        </div>

       {% comment %} This is the new "Send Message" form {% endcomment %}
<div class="send-message-form">
    <form method="POST" style="display: flex; gap: 10px;">
        {% csrf_token %}

        {% comment %} 
          This renders our stylish form field.
          'as_p' isn't needed since we styled it in forms.py
        {% endcomment %}
        <div style="flex-grow: 1;">
            {{ form.body }}
        </div>

        <button type="submit" style="background: #0066cc; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; height: min-content;">
            Send
        </button>
    </form>
</div>

{% comment %} 
  --- Professional Touch (Optional but Recommended) ---
  Add this script to the bottom of the file (after the form)
  to auto-scroll the chat box to the newest message.
{% endcomment %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        var chatBox = document.querySelector(".chat-messages");
        if (chatBox) {
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    });
</script>
        
    </div>
</div>
{% endblock content %}