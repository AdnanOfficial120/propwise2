{% extends 'base.html' %}

{% block content %}
<div class="container" style="margin-top: 20px;">
    
    {% comment %} --- 1. AGENT INFO HEADER --- {% endcomment %}
    <div class="agent-header" style="background: #f4f4f4; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
        
        {% if agent.profile_picture %}
            <img src="{{ agent.profile_picture.url }}" alt="{{ agent.username }}'s profile picture" style="height: 120px; width: 120px; object-fit: cover; border-radius: 50%;">
        {% else %}
            {% comment %} A simple placeholder if they have no image {% endcomment %}
            <div style="height: 120px; width: 120px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; color: #666;">
                {{ agent.username.0|upper }}
            </div>
        {% endif %}
        
        <div>
            <h2 style="margin: 0 0 5px 0;">{{ agent.first_name }} {{ agent.last_name }}</h2>
            <p style="margin: 0; font-size: 1.2em; color: #333;">@{{ agent.username }}</p>
            
            {% if agent.phone_number %}
                <p style="margin: 10px 0 0 0; color: #555;"><strong>Phone:</strong> {{ agent.phone_number }}</p>
            {% endif %}
            <p style="margin: 5px 0 0 0; color: #555;"><strong>Email:</strong> {{ agent.email }}</p>
        </div>
    </div>

    {% comment %} --- 2. AGENT'S LISTINGS --- {% endcomment %}
    <h3>Listings by {{ agent.first_name|default:agent.username }}</h3>

    <div class="property-list">
        {% for prop in properties %}
            <div class="property-card">
                
                {% if prop.main_image %}
                    <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                {% endif %}
                
                <h4>
                    <a href="{% url 'property_detail' pk=prop.pk %}">
                        {{ prop.title }}
                    </a>
                </h4>

                <p><strong>Price:</strong> PKR {{ prop.price }}</p>
                <p><strong>Location:</strong> {{ prop.area }}</p>
                <p><strong>Type:</strong> {{ prop.get_property_type_display }}</p>
                
                <p style="margin-top: 10px;">
                    <a href="{% url 'property_detail' pk=prop.pk %}" style="
                        display: inline-block;
                        padding: 8px 16px;
                        background-color: #0066cc;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 14px;
                    ">
                        View Details
                    </a>
                    
                    {% comment %} We include the Save/Unsave logic here too {% endcomment %}
                    {% if user.is_authenticated %}
                        {% if prop in user.favorites.all %}
                            <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                
                                {% comment %} --- THIS IS THE CORRECTED STYLE --- {% endcomment %}
                                <button type="submit" style="
                                    background: #dc3545; 
                                    color: white; 
                                    padding: 5px 10px; 
                                    border: none; 
                                    border-radius: 4px; 
                                    cursor: pointer; 
                                    font-size: 14px; 
                                    margin-left: 10px;
                                ">Unsave</button>
                            </form>
                        {% else %}
                            <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}

                                {% comment %} --- THIS IS THE CORRECTED STYLE --- {% endcomment %}
                                <button type="submit" style="
                                    background: #007bff; 
                                    color: white; 
                                    padding: 5px 10px; 
                                    border: none; 
                                    border-radius: 4px; 
                                    cursor: pointer; 
                                    font-size: 14px; 
                                    margin-left: 10px;
                                ">Save</button>
                            </form>
                        {% endif %}
                    {% else %}

                        {% comment %} --- THIS IS THE CORRECTED STYLE --- {% endcomment %}
                        <a href="{% url 'login' %}?next={{ request.path }}" style="
                            background: #007bff; 
                            color: white; 
                            padding: 5px 10px; 
                            border: none; 
                            border-radius: 4px; 
                            font-size: 14px; 
                            margin-left: 10px; 
                            text-decoration: none;
                        ">Save</a>
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>{{ agent.first_name|default:"This agent" }} has no active listings at this time.</p>
        {% endfor %}
    </div>
</div>
{% endblock content %}