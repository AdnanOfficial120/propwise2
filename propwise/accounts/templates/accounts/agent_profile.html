{% extends 'base.html' %}

{% block content %}

{% comment %}
    We will add some simple styles for the new review sections.
    This keeps everything in one file for now.
{% endcomment %}
<style>
    .review-section-container {
        display: grid;
        grid-template-columns: 1fr; /* Default to 1 column */
        gap: 30px;
        margin-top: 30px;
    }
    
    /* On larger screens, split into 2 columns */
    @media (min-width: 768px) {
        .review-section-container {
            grid-template-columns: 1fr 2fr; /* 1/3 for form, 2/3 for list */
        }
    }

    .review-form-box, .review-list-box {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        background: #f9f9f9;
    }

    .review-card {
        border-bottom: 1px solid #eee;
        padding: 15px 0;
    }
    .review-card:last-child {
        border-bottom: none;
    }
    .review-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
    }
    .review-card-header strong {
        font-size: 1.1em;
    }
    .review-card-header .rating-stars {
        font-size: 1.2em;
        color: #f0ad4e; /* Yellow for stars */
    }
    .review-card p {
        margin: 5px 0 0 0;
        line-height: 1.5;
    }

    /* Simple star rating display */
    .star-rating-display {
        color: #f0ad4e; /* Yellow for stars */
        font-size: 1.3em;
        font-weight: bold;
    }
    
    /* Make the new form fields look good */
    .review-form-box select,
    .review-form-box textarea,
    .review-form-box button {
        width: 100%;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        box-sizing: border-box; /* Important for 100% width */
    }
    .review-form-box button {
        background: #28a745;
        color: white;
        font-weight: bold;
        cursor: pointer;
    }
</style>


<div class="container" style="margin-top: 20px;">
    
    {% comment %} --- 1. AGENT INFO HEADER (UPGRADED) --- {% endcomment %}
    <div class="agent-header" style="background: #f4f4f4; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; align-items: center; gap: 20px;">
        
        {% if agent.profile_picture %}
            <img src="{{ agent.profile_picture.url }}" alt="{{ agent.username }}'s profile picture" style="height: 120px; width: 120px; object-fit: cover; border-radius: 50%;">
        {% else %}
            <div style="height: 120px; width: 120px; background: #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 2em; color: #666;">
                {{ agent.username.0|upper }}
            </div>
        {% endif %}
        
        <div>
            <h2 style="margin: 0 0 5px 0;">{{ agent.first_name }} {{ agent.last_name }}</h2>
            <p style="margin: 0; font-size: 1.2em; color: #333;">@{{ agent.username }}</p>
            
            {% if agent.phone_number %}
                <p style="margin: 10px 0 0 0; color: #555;"><strong>Phone:</strong> {{ agent.phone_number }}</p>
            {% endif %}
            <p style="margin: 5px 0 0 0; color: #555;"><strong>Email:</strong> {{ agent.email }}</p>

            {% comment %} --- START: NEW RATING DISPLAY --- {% endcomment %}
            <div style="margin-top: 10px;">
                {% if rating_stats.total_reviews > 0 %}
                    <span class="star-rating-display">
                        {{ rating_stats.avg_rating|floatformat:1 }} ★
                    </span>
                    <span style="color: #666; margin-left: 5px;">
                        (based on {{ rating_stats.total_reviews }} review{{ rating_stats.total_reviews|pluralize }})
                    </span>
                {% else %}
                    <strong style="color: #666;">This agent has no reviews yet.</strong>
                {% endif %}
            </div>
            {% comment %} --- END: NEW RATING DISPLAY --- {% endcomment %}

        </div>
    </div>

    {% comment %} --- 2. AGENT'S LISTINGS (No changes here) --- {% endcomment %}
    <h3>Listings by {{ agent.first_name|default:agent.username }}</h3>

    <div class="property-list">
        {% for prop in properties %}
            <div class="property-card">
                
                {% if prop.main_image %}
                    <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                {% endif %}
                
                <h4>
                    <a href="{% url 'property_detail' pk=prop.pk %}">
                        {{ prop.title }}
                    </a>
                </h4>

                <p><strong>Price:</strong> PKR {{ prop.price }}</p>
                <p><strong>Location:</strong> {{ prop.area }}</p>
                <p><strong>Type:</strong> {{ prop.get_property_type_display }}</p>
                
                <p style="margin-top: 10px;">
                    <a href="{% url 'property_detail' pk=prop.pk %}" style="
                        display: inline-block;
                        padding: 8px 16px;
                        background-color: #0066cc;
                        color: white;
                        text-decoration: none;
                        border-radius: 4px;
                        font-size: 14px;
                    ">
                        View Details
                    </a>
                    
                    {% comment %} Save/Unsave logic (No changes here) {% endcomment %}
                    {% if user.is_authenticated %}
                        {% if prop in user.favorites.all %}
                            <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #dc3545; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Unsave</button>
                            </form>
                        {% else %}
                            <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" style="
                                    background: #007bff; color: white; padding: 5px 10px; border: none; 
                                    border-radius: 4px; cursor: pointer; font-size: 14px; margin-left: 10px;
                                ">Save</button>
                            </form>
                        {% endif %}
                    {% else %}
                        <a href="{% url 'login' %}?next={{ request.path }}" style="
                            background: #007bff; color: white; padding: 5px 10px; border: none; 
                            border-radius: 4px; font-size: 14px; margin-left: 10px; text-decoration: none;
                        ">Save</a>
                    {% endif %}
                </p>
            </div>
        {% empty %}
            <p>{{ agent.first_name|default:"This agent" }} has no active listings at this time.</p>
        {% endfor %}
    </div>

    <hr style="margin: 40px 0;">

    {% comment %} --- START: NEW RATINGS & REVIEWS SECTION --- {% endcomment %}

    <h2>Ratings & Reviews for {{ agent.first_name|default:agent.username }}</h2>

    <div class="review-section-container">
        
        <div class="review-form-box">
            <h4>Leave a Review</h4>
            
            {% if user_can_review %}
                <form method="POST" class="review-form">
                    {% csrf_token %}
                    
                    <div>
                        <label for="{{ review_form.rating.id_for_label }}">{{ review_form.rating.label }}</label>
                        {{ review_form.rating }}
                    </div>
                    
                    <div style="margin-top: 10px;">
                        <label for="{{ review_form.comment.id_for_label }}">{{ review_form.comment.label }}</label>
                        {{ review_form.comment }}
                    </div>
                    
                    {% if review_form.errors %}
                        <div style="color: red; font-size: 0.9em; margin-top: 5px;">
                            {{ review_form.errors }}
                        </div>
                    {% endif %}
                    
                    <button type="submit" style="margin-top: 15px;">Submit Review</button>
                </form>

            {% elif user_has_reviewed %}
                <p style="color: #155724; background: #d4edda; padding: 10px; border-radius: 5px;">
                    <strong>Thank you!</strong> You have already submitted a review for this agent.
                </p>

            {% elif not user.is_authenticated %}
                <p>
                    <a href="{% url 'login' %}?next={{ request.path }}">Log in</a> as a buyer to leave a review.
                </p>

            {% elif user == agent %}
                <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px;">
                    You cannot review your own profile.
                </p>
                
            {% else %}
                 <p style="color: #721c24; background: #f8d7da; padding: 10px; border-radius: 5px;">
                    Only buyers can leave reviews.
                </p>
            {% endif %}
        </div>

        <div class="review-list-box">
            <h4>What Others Say</h4>

            {% for review in all_reviews %}
                <div class="review-card">
                    <div class="review-card-header">
                        <strong>
                            {% if review.reviewer %}
                                {{ review.reviewer.username }}
                            {% else %}
                                Anonymized User
                            {% endif %}
                        </strong>
                        <span class="rating-stars">
                            {{ review.rating }} ★
                        </span>
                    </div>
                    <p style="color: #666; font-size: 0.9em;">
                        Reviewed {{ review.created_at|timesince }} ago
                    </p>
                    
                    {% if review.comment %}
                        <p>{{ review.comment }}</p>
                    {% endif %}
                </div>
            {% empty %}
                <p>This agent has no reviews yet. Be the first to leave one!</p>
            {% endfor %}
        </div>
    </div>
    {% comment %} --- END: NEW RATINGS & REVIEWS SECTION --- {% endcomment %}

</div>
{% endblock content %}