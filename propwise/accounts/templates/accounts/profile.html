{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* --- PAGE CONTAINER --- */
    .settings-container {
        max-width: 800px;
        margin: 40px auto;
        padding: 0 20px;
    }

    .settings-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        overflow: hidden;
    }

    /* --- HEADER SECTION --- */
    .settings-header {
        background: var(--pw-navy);
        padding: 40px 30px;
        text-align: center;
        color: white;
        position: relative;
    }

    .settings-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        margin-bottom: 5px;
    }
    .settings-subtitle {
        color: #cbd5e1;
        font-size: 0.9rem;
    }

    /* --- PROFILE PICTURE EDITOR --- */
    .profile-pic-wrapper {
        position: relative;
        width: 120px;
        height: 120px;
        margin: -60px auto 30px; /* Pulls it up into the header */
        z-index: 10;
    }

    .profile-img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid white;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        background: #f1f5f9;
    }

    /* The Camera Button Overlay */
    .upload-btn {
        position: absolute;
        bottom: 5px;
        right: 5px;
        width: 35px;
        height: 35px;
        background: var(--pw-gold);
        color: var(--pw-navy);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border: 2px solid white;
        transition: 0.3s;
    }
    .upload-btn:hover { transform: scale(1.1); background: white; color: var(--pw-gold); }

    /* Hide the default file input */
    input[type="file"] { display: none; }


    /* --- FORM STYLING --- */
    .settings-form {
        padding: 0 40px 40px;
    }

    /* Grid System for Form Fields */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 Columns */
        gap: 20px;
    }

    .form-group { margin-bottom: 20px; }
    
    /* Make full width fields span both columns */
    .form-group.full-width { grid-column: span 2; }

    .form-label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--pw-navy);
        margin-bottom: 8px;
        text-transform: uppercase;
    }

    /* Target Django Inputs */
    .settings-form input[type="text"],
    .settings-form input[type="email"],
    .settings-form input[type="number"],
    .settings-form input[type="tel"],
    .settings-form textarea,
    .settings-form select {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-family: 'Poppins', sans-serif;
        font-size: 1rem;
        color: var(--pw-navy);
        background: #f8fafc;
        transition: all 0.3s;
    }

    .settings-form input:focus, .settings-form textarea:focus {
        background: white;
        border-color: var(--pw-gold);
        box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.1);
        outline: none;
    }

    /* BUTTONS */
    .btn-save {
        width: 100%;
        padding: 14px;
        background: var(--pw-navy);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: 0.3s;
        box-shadow: 0 4px 12px rgba(15, 23, 42, 0.2);
    }
    .btn-save:hover {
        background: var(--pw-gold);
        transform: translateY(-2px);
    }

    /* Responsive */
    @media (max-width: 600px) {
        .form-grid { grid-template-columns: 1fr; } /* Stack on mobile */
        .form-group.full-width { grid-column: span 1; }
        .settings-form { padding: 0 20px 30px; }
    }
</style>

<div class="settings-container">
    <div class="settings-card">
        
        <!-- Header -->
        <div class="settings-header">
            <h1 class="settings-title">Edit Profile</h1>
            <p class="settings-subtitle">Update your personal details and public profile.</p>
        </div>

        <form method="POST" enctype="multipart/form-data" class="settings-form">
            {% csrf_token %}

            <!-- PROFILE PICTURE SECTION -->
            <div class="profile-pic-wrapper">
                <!-- Image Preview -->
                {% if user.profile_picture %}
                    <img src="{{ user.profile_picture.url }}" alt="Profile" class="profile-img" id="preview-img">
                {% else %}
                    <!-- Fallback Placeholder if no image -->
                    <div class="profile-img" id="preview-img" style="display:flex; align-items:center; justify-content:center; font-size:3rem; color:#cbd5e1; background:#f1f5f9;">
                        <i class="fa-solid fa-user"></i>
                    </div>
                {% endif %}
                
                <!-- Magic Upload Button -->
                <label for="id_profile_picture" class="upload-btn" title="Change Photo">
                    <i class="fa-solid fa-camera"></i>
                </label>
            </div>

            <!-- FORM FIELDS GRID -->
            <div class="form-grid">
                
                {% for field in form %}
                    {% if field.name == 'profile_picture' %}
                        <!-- We handle the file input manually above, so render it hidden here just to connect logic -->
                        <div style="display:none;">{{ field }}</div>
                    {% else %}
                        <!-- Logic to make Bio/Address full width, others half width -->
                        <div class="form-group {% if field.name == 'bio' or field.name == 'address' or field.name == 'email' %}full-width{% endif %}">
                            <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                            {{ field }}
                            {% if field.errors %}
                                <div style="color:#ef4444; font-size:0.8rem; margin-top:5px;">{{ field.errors|striptags }}</div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

            </div>

            <hr style="border:0; border-top:1px solid #f1f5f9; margin: 20px 0 30px;">

            <button type="submit" class="btn-save">Save Changes</button>
            
            <div style="text-align:center; margin-top:15px;">
                <a href="{% url 'homepage' %}" style="color:#94a3b8; font-size:0.9rem;">Cancel</a>
            </div>

        </form>
    </div>
</div>

<!-- JAVASCRIPT FOR INSTANT IMAGE PREVIEW -->
<script>
    // Find the file input (Django usually names it id_profile_picture)
    const fileInput = document.getElementById('id_profile_picture');
    const previewImg = document.getElementById('preview-img');

    if (fileInput) {
        fileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    // If preview is an IMG tag, set src
                    if (previewImg.tagName === 'IMG') {
                        previewImg.src = e.target.result;
                    } else {
                        // If preview was a DIV (placeholder), replace it with an IMG
                        const newImg = document.createElement('img');
                        newImg.src = e.target.result;
                        newImg.className = 'profile-img';
                        newImg.id = 'preview-img';
                        previewImg.parentNode.replaceChild(newImg, previewImg);
                    }
                }
                
                reader.readAsDataURL(file);
            }
        });
    }
</script>

{% endblock content %}