{% extends 'base.html' %}
{% load static %}
{% load humanize %}

{% block content %}

<style>
    /* --- PAGE CONTAINER --- */
    .compare-container {
        max-width: 1300px;
        margin: 40px auto;
        padding: 0 20px;
        min-height: 70vh;
    }

    /* --- HEADER --- */
    .compare-header {
        text-align: center;
        margin-bottom: 40px;
    }
    .compare-title {
        font-family: 'Playfair Display', serif;
        font-size: 2.5rem;
        color: var(--pw-navy);
        margin-bottom: 10px;
    }
    .compare-sub { color: #64748b; font-size: 1.1rem; }

    /* --- COMPARISON TABLE WRAPPER --- */
    .table-wrapper {
        overflow-x: auto; /* Horizontal Scroll */
        background: white;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.05);
        border: 1px solid #f1f5f9;
        padding-bottom: 10px;
        /* Smooth scrolling on iOS */
        -webkit-overflow-scrolling: touch; 
    }

    .comp-table {
        width: 100%;
        border-collapse: separate; /* Required for sticky headers */
        border-spacing: 0;
        min-width: 800px; /* Ensure desktop looks good */
    }

    /* --- STICKY HEADER ROW (Images) --- */
    .comp-table thead th {
        position: sticky;
        top: 0; 
        background: white;
        z-index: 20;
        padding: 20px;
        border-bottom: 2px solid #f1f5f9;
        vertical-align: bottom;
    }
    
    /* The "Features" label column (Top Left Corner) */
    .comp-table thead th:first-child {
        position: sticky;
        left: 0;
        z-index: 30; /* Highest z-index */
        background: #f8fafc;
        width: 200px;
        min-width: 200px;
        border-right: 1px solid #e2e8f0;
    }

    /* Property Card in Header */
    .prop-header-card {
        text-align: center;
        position: relative;
        min-width: 220px; /* Minimum width for property column */
    }
    
    .prop-img-box {
        width: 100%;
        height: 160px;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 15px;
        position: relative;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .prop-img-box img { width: 100%; height: 100%; object-fit: cover; }

    /* Remove Button (X) */
    .btn-remove-prop {
        position: absolute;
        top: 5px; right: 5px;
        width: 25px; height: 25px;
        background: rgba(0,0,0,0.6);
        color: white;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.8rem;
        transition: 0.2s;
    }
    .btn-remove-prop:hover { background: #ef4444; }

    .prop-name {
        font-family: 'Playfair Display', serif;
        font-size: 1.1rem;
        color: var(--pw-navy);
        font-weight: 700;
        margin-bottom: 5px;
        display: block;
        text-decoration: none;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* --- DATA ROWS --- */
    .comp-table tbody tr {
        transition: 0.1s;
    }
    .comp-table tbody tr:hover { background: #f8fafc; }

    /* Feature Label Column (Sticky Left) */
    .comp-table tbody td:first-child {
        position: sticky;
        left: 0;
        z-index: 10;
        background: #f8fafc;
        font-weight: 600;
        color: #64748b;
        padding: 20px;
        border-right: 1px solid #e2e8f0;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Data Cells */
    .comp-table tbody td {
        padding: 20px;
        text-align: center;
        color: var(--pw-navy);
        font-size: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f1f5f9;
    }

    /* Special Rows */
    .row-price td {
        font-size: 1.3rem;
        font-weight: 700;
        color: var(--pw-gold);
        font-family: 'Playfair Display', serif;
    }

    .verified-badge {
        display: inline-block; padding: 4px 10px;
        background: #ecfdf5; color: #059669;
        border-radius: 20px; font-size: 0.8rem; font-weight: 700;
    }
    .unverified-badge { color: #94a3b8; font-size: 0.8rem; font-style: italic; }

    .btn-view-details {
        display: inline-block; padding: 10px 20px;
        background: var(--pw-navy); color: white;
        text-decoration: none; border-radius: 6px;
        font-weight: 600; font-size: 0.9rem;
    }

    /* Empty State */
    .empty-compare {
        text-align: center; padding: 80px; color: #94a3b8;
        background: #f8fafc; border-radius: 16px; border: 2px dashed #e2e8f0;
    }

    /* --- MOBILE OPTIMIZATION (Short & Tight) --- */
    @media (max-width: 768px) {
        .compare-container { padding: 0 10px; margin: 20px auto; }
        .compare-title { font-size: 1.8rem; }
        .compare-sub { font-size: 0.9rem; margin-bottom: 20px; }

        /* Shrink Table Elements */
        .comp-table { min-width: auto; } /* Allow flexible width */
        
        /* Sticky Header tweaks */
        .comp-table thead th { padding: 10px; }
        
        /* Sticky Feature Column (Make it narrower) */
        .comp-table thead th:first-child,
        .comp-table tbody td:first-child {
            width: 110px; /* Much tighter */
            min-width: 110px;
            padding: 10px;
            font-size: 0.8rem;
        }

        /* Property Column Width */
        .prop-header-card { min-width: 160px; } /* Smaller width per property */

        /* Property Image (Shorter) */
        .prop-img-box { height: 100px; margin-bottom: 8px; }
        
        /* Font Sizes */
        .prop-name { font-size: 0.9rem; }
        .comp-table tbody td { padding: 10px 5px; font-size: 0.85rem; }
        
        /* Price Row */
        .row-price td { font-size: 1rem; }
        
        /* Buttons */
        .btn-view-details { padding: 6px 10px; font-size: 0.75rem; }
        .verified-badge { font-size: 0.65rem; padding: 2px 6px; }
    }
</style>

<div class="compare-container">
    
    <div class="compare-header">
        <h1 class="compare-title">Compare Properties</h1>
        <p class="compare-sub">Side-by-side comparison.</p>
        <a href="{% url 'property_search' %}" style="color:var(--pw-gold); font-weight:600; text-decoration:none; font-size:0.9rem;">&larr; Add More</a>
    </div>

    {% if not properties %}
        <div class="empty-compare">
            <i class="fa-solid fa-scale-unbalanced" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.5;"></i>
            <h3>List Empty</h3>
            <p>Add properties from search to compare.</p>
            <a href="{% url 'property_search' %}" class="btn-view-details" style="margin-top:20px;">Browse</a>
        </div>
    {% else %}
    
        <div class="table-wrapper">
            <table class="comp-table">
                <thead>
                    <tr>
                        <th>Features</th>
                        {% for prop in properties %}
                        <th>
                            <div class="prop-header-card">
                                <div class="prop-img-box">
                                    {% if prop.main_image %}
                                        <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}">
                                    {% else %}
                                        <div style="width:100%; height:100%; background:#eee; display:flex; align-items:center; justify-content:center; color:#ccc;"><i class="fa-solid fa-image"></i></div>
                                    {% endif %}
                                    
                                    <form action="{% url 'remove_from_compare' pk=prop.pk %}" method="POST">
                                        {% csrf_token %}
                                        <button type="submit" class="btn-remove-prop"><i class="fa-solid fa-xmark"></i></button>
                                    </form>
                                </div>
                                <a href="{% url 'property_detail' pk=prop.pk %}" class="prop-name">{{ prop.title|truncatechars:20 }}</a>
                            </div>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- Price Row -->
                    <tr class="row-price">
                        <td>Price</td>
                        {% for prop in properties %}
                            <td>PKR {{ prop.price|intcomma }}</td>
                        {% endfor %}
                    </tr>

                    <!-- Location -->
                    <tr>
                        <td>City</td>
                        {% for prop in properties %}
                            <td>{{ prop.area.city.name }}</td>
                        {% endfor %}
                    </tr>

                    <!-- Area -->
                    <tr>
                        <td>Area</td>
                        {% for prop in properties %}
                            <td>{{ prop.area.name }}</td>
                        {% endfor %}
                    </tr>

                    <!-- Status -->
                    <tr>
                        <td>Verified</td>
                        {% for prop in properties %}
                            <td>
                                {% if prop.is_verified %}
                                    <span class="verified-badge">Yes</span>
                                {% else %}
                                    <span class="unverified-badge">No</span>
                                {% endif %}
                            </td>
                        {% endfor %}
                    </tr>

                    <!-- Features -->
                    <tr>
                        <td>Type</td>
                        {% for prop in properties %}
                            <td>{{ prop.get_property_type_display }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Beds</td>
                        {% for prop in properties %}
                            <td>{{ prop.bedrooms|default:"-" }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Baths</td>
                        {% for prop in properties %}
                            <td>{{ prop.bathrooms|default:"-" }}</td>
                        {% endfor %}
                    </tr>
                    <tr>
                        <td>Size</td>
                        {% for prop in properties %}
                            <td>{{ prop.area_size }} <small>{{ prop.get_area_unit_display }}</small></td>
                        {% endfor %}
                    </tr>

                    <!-- Actions Footer -->
                    <tr>
                        <td></td>
                        {% for prop in properties %}
                            <td>
                                <a href="{% url 'property_detail' pk=prop.pk %}" class="btn-view-details">View</a>
                            </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>

    {% endif %}

</div>

{% endblock content %}