{% extends 'base.html' %}
{% load static %}

{% block content %}

<style>
    /* --- PAGE LAYOUT --- */
    .search-page-container {
        max-width: 1400px;
        margin: 40px auto;
        padding: 0 20px;
        display: grid;
        grid-template-columns: 300px 1fr; /* Sidebar | Results */
        gap: 30px;
        align-items: start;
    }

    /* --- SIDEBAR (FILTERS) --- */
    .sidebar {
        background: white;
        border-radius: 12px;
        padding: 25px;
        border: 1px solid #f1f5f9;
        box-shadow: 0 5px 15px rgba(0,0,0,0.03);
        position: sticky;
        top: 140px; /* Stick below navbar */
        height: fit-content;
        max-height: 85vh;
        overflow-y: auto;
    }

    .sidebar-title {
        font-family: 'Playfair Display', serif;
        font-size: 1.2rem;
        color: var(--pw-navy);
        margin-bottom: 20px;
        font-weight: 700;
        border-bottom: 2px solid #f1f5f9;
        padding-bottom: 10px;
    }

    /* Filter Form Styles */
    .filter-group label {
        display: block;
        font-size: 0.85rem;
        font-weight: 600;
        color: #64748b;
        margin-bottom: 5px;
    }
    
    .filter-group input, .filter-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        margin-bottom: 15px;
        font-family: 'Poppins', sans-serif;
    }

    .btn-filter {
        width: 100%;
        background: var(--pw-navy);
        color: white;
        padding: 10px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        margin-top: 10px;
    }
    .btn-filter:hover { background: var(--pw-gold); color: var(--pw-navy); }

    /* Mobile Toggle for Sidebar */
    .mobile-filter-toggle {
        display: none; /* Hidden on Desktop */
        width: 100%;
        padding: 12px;
        background: white;
        border: 1px solid #e2e8f0;
        color: var(--pw-navy);
        font-weight: 700;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 20px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }

    /* --- SAVE SEARCH WIDGET --- */
    .save-search-box {
        background: #f8fafc;
        padding: 15px;
        border-radius: 8px;
        margin-top: 30px;
        border: 1px dashed #cbd5e1;
        text-align: center;
    }
    .btn-save-search {
        background: #10b981;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 4px;
        font-size: 0.9rem;
        width: 100%;
        cursor: pointer;
        margin-top: 10px;
    }

    /* --- RESULTS GRID --- */
    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .results-count { color: #64748b; font-size: 0.9rem; }

    .property-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 25px;
    }

    /* --- PREMIUM PROPERTY CARD --- */
    .prop-card {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        border: 1px solid #f1f5f9;
        transition: 0.3s;
        position: relative;
    }
    .prop-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 30px rgba(0,0,0,0.08);
        border-color: rgba(212, 175, 55, 0.3);
    }

    /* Image Area */
    .card-img-wrap {
        position: relative;
        height: 200px;
        overflow: hidden;
    }
    .card-img {
        width: 100%; height: 100%; object-fit: cover; transition: 0.5s;
    }
    .prop-card:hover .card-img { transform: scale(1.05); }

    /* Badges Overlay */
    .badge-verified {
        position: absolute; top: 10px; left: 10px;
        background: #10b981; color: white;
        font-size: 0.7rem; font-weight: 700;
        padding: 4px 10px; border-radius: 20px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Compare Checkbox Overlay */
    .compare-overlay {
        position: absolute; top: 10px; right: 10px;
        background: rgba(255,255,255,0.95);
        padding: 5px 10px; border-radius: 20px;
        display: flex; align-items: center; gap: 5px;
        font-size: 0.75rem; font-weight: 600;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    .compare-overlay input { cursor: pointer; }

    /* Card Content */
    .card-content { padding: 20px; }
    
    .card-price {
        font-size: 1.2rem; color: var(--pw-gold);
        font-weight: 700; margin-bottom: 5px;
    }
    
    .card-title {
        font-size: 1.1rem; font-weight: 700; color: var(--pw-navy);
        margin-bottom: 5px; display: block;
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    .card-loc {
        font-size: 0.85rem; color: #64748b; margin-bottom: 15px;
        display: flex; align-items: center; gap: 5px;
    }

    /* Card Footer */
    .card-footer {
        display: flex; justify-content: space-between; align-items: center;
        padding-top: 15px; border-top: 1px solid #f1f5f9;
    }

    .btn-view {
        background: var(--pw-navy); color: white;
        padding: 6px 15px; border-radius: 4px; font-size: 0.85rem;
    }
    .btn-view:hover { background: var(--pw-gold); }

    /* --- PAGINATION --- */
    .pagination {
        margin-top: 50px; text-align: center;
    }
    .page-link {
        display: inline-block; padding: 8px 16px;
        background: white; border: 1px solid #e2e8f0;
        color: var(--pw-navy); border-radius: 6px;
        margin: 0 5px; font-weight: 500;
    }
    .page-link:hover { background: #f8fafc; border-color: var(--pw-navy); }
    .page-current {
        background: var(--pw-navy); color: white; border-color: var(--pw-navy);
    }

    /* --- FLOATING COMPARE BAR --- */
    .floating-compare-bar {
        position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
        width: 90%; max-width: 500px;
        background: var(--pw-navy); color: white;
        padding: 15px 25px; border-radius: 50px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        display: flex; justify-content: space-between; align-items: center;
        transition: bottom 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        z-index: 2000;
        border: 2px solid var(--pw-gold);
    }
    .floating-compare-bar.visible { bottom: 30px; }
    
    .btn-compare-now {
        background: var(--pw-gold); color: var(--pw-navy);
        padding: 8px 20px; border-radius: 30px; text-decoration: none; font-weight: 700;
    }

    /* --- RESPONSIVE --- */
    @media (max-width: 900px) {
        .search-page-container { grid-template-columns: 1fr; }
        .sidebar { display: none; } /* Hide sidebar by default */
        .sidebar.active { display: block; animation: fadeIn 0.3s; }
        .mobile-filter-toggle { display: block; }
    }
    @keyframes fadeIn { from { opacity:0; transform:translateY(-10px); } to { opacity:1; transform:translateY(0); } }
</style>

<!-- HEADER -->
<div style="background: var(--pw-navy); padding: 40px 0; text-align: center; color: white; margin-top: -20px;">
    <h1 style="font-family: 'Playfair Display', serif;">Find Your Property</h1>
    <p style="color: #94a3b8; font-size: 0.9rem;"><a href="/" style="color:white;">Home</a> / Search Results</p>
</div>

<div class="search-page-container">

    <!-- MOBILE TOGGLE BUTTON -->
    <div class="mobile-filter-toggle" onclick="toggleSidebar()">
        <i class="fa-solid fa-sliders"></i> Show Filters
    </div>

    <!-- SIDEBAR -->
    <aside class="sidebar" id="filterSidebar">
        <div class="sidebar-title">Refine Search</div>
        
        <!-- Filter Form -->
        <form method="get" class="filter-group">
            {% if filter.form %}
                {{ filter.form.as_p }}
            {% else %}
                <p style="font-size:0.9rem; color:#64748b;">Use the homepage to search.</p>
            {% endif %}
            <button type="submit" class="btn-filter">Apply Filters</button>
        </form>

        <!-- Save Search Widget -->
        <div class="save-search-box">
            <h5 style="margin-bottom:5px; color:var(--pw-navy);">Save Search</h5>
            <p style="font-size:0.8rem; color:#64748b; margin-bottom:10px;">Get alerts for new matches.</p>
            
            {% if user.is_authenticated %}
                <form method="post">
                    {% csrf_token %}
                    {{ saved_search_form.as_p }}
                    <button type="submit" class="btn-save-search">Save & Alert Me</button>
                </form>
            {% else %}
                <a href="{% url 'login' %}?next={{ request.get_full_path|urlencode }}" class="btn-save-search" style="display:block; text-decoration:none;">Log in to Save</a>
            {% endif %}
        </div>
    </aside>

    <!-- RESULTS -->
    <main class="results-area">
        <div class="results-header">
            <h3 style="font-family:'Playfair Display', serif; color:var(--pw-navy);">Properties</h3>
            <span class="results-count">{{ page_obj.paginator.count }} Listings Found</span>
        </div>

        <div class="property-grid">
            {% for prop in filter.qs %}
                <div class="prop-card">
                    
                    <div class="card-img-wrap">
                        <!-- Link Image to Detail -->
                        {% if prop.main_image %}
                            <a href="{% url 'property_detail' pk=prop.pk %}">
                                <img src="{{ prop.main_image.url }}" alt="{{ prop.title }}" class="card-img">
                            </a>
                        {% endif %}

                        <!-- Badges -->
                        {% if prop.is_verified %}
                            <div class="badge-verified"><i class="fa-solid fa-check"></i> Verified</div>
                        {% endif %}

                        <!-- Compare Overlay -->
                        <div class="compare-overlay">
                            <input type="checkbox" class="compare-checkbox" id="compare-{{ prop.pk }}" data-id="{{ prop.pk }}" {% if prop.pk in request.session.compare_list %}checked{% endif %}>
                            <label for="compare-{{ prop.pk }}" style="cursor:pointer;">Compare</label>
                        </div>
                    </div>

                    <div class="card-content">
                        <div class="card-price">PKR {{ prop.price }}</div>
                        <a href="{% url 'property_detail' pk=prop.pk %}" class="card-title">{{ prop.title }}</a>
                        <div class="card-loc"><i class="fa-solid fa-location-dot"></i> {{ prop.area }}</div>
                        
                        <div style="font-size:0.85rem; color:#64748b; display:flex; gap:15px; border-bottom:1px solid #f1f5f9; padding-bottom:10px; margin-bottom:10px;">
                            <span><i class="fa-solid fa-bed"></i> {{ prop.bedrooms|default:"-" }}</span>
                            <span><i class="fa-solid fa-bath"></i> {{ prop.bathrooms|default:"-" }}</span>
                            <span><i class="fa-solid fa-ruler-combined"></i> {{ prop.get_property_type_display }}</span>
                        </div>

                        <div class="card-footer">
                            <a href="{% url 'property_detail' pk=prop.pk %}" class="btn-view">Details</a>
                            
                            <!-- Save Button Logic -->
                            {% if user.is_authenticated %}
                                {% if prop in user.favorites.all %}
                                    <form action="{% url 'remove_from_favorites' pk=prop.pk %}" method="POST">{% csrf_token %}<button type="submit" style="background:none; border:none; cursor:pointer; color:#ef4444; font-size:1.2rem;"><i class="fa-solid fa-heart"></i></button></form>
                                {% else %}
                                    <form action="{% url 'add_to_favorites' pk=prop.pk %}" method="POST">{% csrf_token %}<button type="submit" style="background:none; border:none; cursor:pointer; color:#cbd5e1; font-size:1.2rem;"><i class="fa-regular fa-heart"></i></button></form>
                                {% endif %}
                            {% else %}
                                <a href="{% url 'login' %}?next={{ request.path }}" style="color:#cbd5e1; font-size:1.2rem;"><i class="fa-regular fa-heart"></i></a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <div style="grid-column: 1 / -1; text-align: center; padding: 50px; background: #f8fafc; border-radius: 12px;">
                    <i class="fa-regular fa-folder-open" style="font-size: 3rem; color: #cbd5e1; margin-bottom: 15px;"></i>
                    <h3>No Properties Found</h3>
                    <p style="color:#64748b;">Try adjusting your filters or search for a different location.</p>
                </div>
            {% endfor %}
        </div>

        <!-- PAGINATION -->
        {% if is_paginated %}
        <div class="pagination">
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?page=1{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">&laquo; First</a>
                    <a href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Prev</a>
                {% endif %}

                <span class="page-link page-current">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Next</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}" class="page-link">Last &raquo;</a>
                {% endif %}
            </span>
        </div>
        {% endif %}

    </main>
</div>

<!-- FLOATING COMPARE BAR -->
{% with compare_count=request.session.compare_list|length %}
<div id="compare-bar" class="floating-compare-bar {% if compare_count > 0 %}visible{% endif %}">
    <div style="display:flex; align-items:center; gap:10px;">
        <i class="fa-solid fa-scale-balanced" style="color:var(--pw-gold); font-size:1.2rem;"></i>
        <div>
            <strong id="compare-count" style="font-size:1.1rem;">{{ compare_count }}</strong>
            <span id="compare-text" style="font-size:0.9rem; opacity:0.9;">{% if compare_count == 1 %}Property{% else %}Properties{% endif %} Selected</span>
        </div>
    </div>
    <a href="{% url 'compare_page' %}" class="btn-compare-now">Compare Now</a>
</div>
{% endwith %}

<!-- SCRIPTS -->
<script>
    function toggleSidebar() {
        const sidebar = document.getElementById('filterSidebar');
        sidebar.classList.toggle('active');
    }

    // COMPARE LOGIC (Kept your existing logic, just cleaned up)
    document.addEventListener('DOMContentLoaded', function() {
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');
        const compareBar = document.getElementById('compare-bar');
        const compareCountSpan = document.getElementById('compare-count');
        const compareTextSpan = document.getElementById('compare-text');
        const checkboxes = document.querySelectorAll('.compare-checkbox');

        const addUrl = "{% url 'add_to_compare' pk=0 %}";
        const removeUrl = "{% url 'remove_from_compare' pk=0 %}";

        checkboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                const propertyId = this.dataset.id;
                let url = this.checked ? addUrl.replace('0', propertyId) : removeUrl.replace('0', propertyId);

                fetch(url, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    const count = data.compare_list_count;
                    compareCountSpan.textContent = count;
                    if (count > 0) {
                        compareBar.classList.add('visible');
                        compareTextSpan.textContent = (count == 1) ? "Property Selected" : "Properties Selected";
                    } else {
                        compareBar.classList.remove('visible');
                    }
                })
                .catch(error => console.error('Error:', error));
            });
        });
    });
</script>

{% endblock content %}