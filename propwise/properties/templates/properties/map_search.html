{% extends 'base.html' %}

{% block content %}

{% comment %}
    STEP 1: We must include the CSS and JavaScript files for Leaflet.js.
    These are 100% free and open-source. We will load them from a CDN.
{% endcomment %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""/>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""></script>

{% comment %}
    STEP 2: We need some custom styles for our map container and the popups.
{% endcomment %}
<style>
    #map { 
        /* You must give the map a height, or it will be invisible */
        height: 75vh; /* 75% of the viewport height */
        width: 100%;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Styles for the popups */
    .leaflet-popup-content-wrapper {
        border-radius: 8px;
    }
    .leaflet-popup-content {
        margin: 10px;
    }
    .popup-card {
        width: 250px;
    }
    .popup-card img {
        width: 100%;
        height: 120px;
        object-fit: cover;
        border-radius: 4px;
    }
    .popup-card h5 {
        margin: 10px 0 5px 0;
        font-size: 1.1em;
    }
    .popup-card p {
        margin: 4px 0;
        font-size: 0.95em;
        color: #333;
    }
    .popup-card a {
        display: block;
        margin-top: 10px;
        padding: 8px;
        background-color: #007bff;
        color: white;
        text-align: center;
        text-decoration: none;
        border-radius: 4px;
        font-weight: bold;
    }
</style>

{% comment %}
    STEP 3: This is the main HTML for the page.
{% endcomment %}
<div class="container" style="margin-top: 20px; margin-bottom: 20px;">
    <h2>Interactive Property Map</h2>
    <p>Explore all available properties. Click a pin to see details.</p>

    <div id="map"></div>
</div>


{% comment %}
    STEP 4: This is the JavaScript "magic" that runs everything.
{% endcomment %}
<script>
    // Wait for the entire page to load
    document.addEventListener('DOMContentLoaded', function() {
        
        // --- 1. Initialize the Map ---
        
        // We set the map's center to the middle of Pakistan
        const map = L.map('map').setView([30.3753, 69.3451], 6); // [lat, lng], zoom level

        // --- 2. Add the Map "Tiles" (The map image) ---
        
        // We use OpenStreetMap, which is 100% free and requires no API key.
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        
        // --- 3. Get the Property Data from our API ---
        
        // === THIS IS THE FIX ===
        // We are using the direct URL to your API.
        // This avoids the Django template error completely.
        const apiUrl = "/listings/api/properties/";
        
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                
                // Now 'data' is our list of property objects from the view
                
                // --- 4. Loop Through Each Property and Add a Pin ---
                data.forEach(function(property) {
                    
                    // Create the marker (the pin)
                    const marker = L.marker([property.lat, property.lng]).addTo(map);

                    // --- 5. Create the Popup Content ---
                    
                    // Set a default image if no main_image is found
                    const imageUrl = property.image_url ? property.image_url : 'https://via.placeholder.com/250x120.png?text=No+Image';

                    const popupContent = `
                        <div class="popup-card">
                            <img src="${imageUrl}" alt="${property.title}">
                            <h5>${property.title}</h5>
                            <p><strong>${property.price}</strong></p>
                            <p>${property.area_name}</p>
                            <a href="${property.detail_url}">View Details</a>
                        </div>
                    `;

                    // Bind the popup to the marker
                    marker.bindPopup(popupContent);
                });

            })
            .catch(error => {
                console.error('Error fetching property data:', error);
            });
    });
</script>

{% endblock content %}